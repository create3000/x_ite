/* X_ITE v11.2.2 */
const t=window[Symbol.for("X_ITE.X3D-11.2.2")];(()=>{var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var i in n)e.o(n,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:n[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};const n=t.Components;var i=e.n(n);const s=t.Fields;var o=e.n(s);const r=t.X3DFieldDefinition;var a=e.n(r);const d=t.FieldDefinitionArray;var h=e.n(d);const u=t.X3DNode;var l=e.n(u);const c=t.X3DGeometricPropertyNode;var p=e.n(c);const _=t.X3DConstants;var m=e.n(_);const g=t.Namespace;var w=e.n(g);function T(t){p().call(this,t),this.addType(m().HAnimDisplacer),this._displacements.setUnit("length")}Object.setPrototypeOf(T.prototype,p().prototype),Object.defineProperties(T,{...l().getStaticProperties("HAnimDisplacer","HAnim",1,"displacers","3.0"),fieldDefinitions:{value:new(h())([new(a())(m().inputOutput,"metadata",new(o().SFNode)),new(a())(m().inputOutput,"description",new(o().SFString)),new(a())(m().inputOutput,"name",new(o().SFString)),new(a())(m().inputOutput,"weight",new(o().SFFloat)),new(a())(m().inputOutput,"coordIndex",new(o().MFInt32)),new(a())(m().inputOutput,"displacements",new(o().MFVec3f))]),enumerable:!0}});const x=T,f=w().add("HAnimDisplacer",x),F=t.X3DChildNode;var I=e.n(F);const O=t.Group;var v=e.n(O);const E=t.Transform;var S=e.n(E);const N=t.X3DBoundedObject;var b=e.n(N);const y=t.TraverseType;var M=e.n(y);const D=t.X3DCast;var A=e.n(D);const j=t.Matrix4;var R=e.n(j);const C=t.Algorithm;var k=e.n(C);function W(t){I().call(this,t),b().call(this,t),this.addType(m().HAnimHumanoid),this.addChildObjects(m().outputOnly,"jointTextures",new(o().SFTime),m().outputOnly,"displacementsTexture",new(o().SFTime),m().outputOnly,"displacementWeightsTexture",new(o().SFTime)),this._translation.setUnit("length"),this._center.setUnit("length"),this._bboxSize.setUnit("length"),this._bboxCenter.setUnit("length"),t.getSpecificationVersion()<=3.3&&(this._version=""),this.skeletonNode=new(v())(t),this.viewpointsNode=new(v())(t),this.skinNode=new B(t,this),this.transformNode=new(S())(t),this.motionNodes=[],this.jointNodes=[],this.jointBindingMatrices=[],this.displacementWeights=[],this.numJoints=0,this.numDisplacements=0,this.update=new X,this.skinning=Function.prototype}Object.assign(Object.setPrototypeOf(W.prototype,I().prototype),b().prototype,{initialize(){I().prototype.initialize.call(this),b().prototype.initialize.call(this),this.skeletonNode.setAllowedTypes(m().HAnimJoint,m().HAnimSite),this.viewpointsNode.setAllowedTypes(m().HAnimSite),this._skeleton.addFieldInterest(this.skeletonNode._children),this._viewpoints.addFieldInterest(this.viewpointsNode._children),this._skin.addFieldInterest(this.skinNode._children),this.skeletonNode._children=this._skeleton,this.viewpointsNode._children=this._viewpoints,this.skinNode._children=this._skin,this.skeletonNode.setPrivate(!0),this.viewpointsNode.setPrivate(!0),this.skinNode.setPrivate(!0),this._translation.addFieldInterest(this.transformNode._translation),this._rotation.addFieldInterest(this.transformNode._rotation),this._scale.addFieldInterest(this.transformNode._scale),this._scaleOrientation.addFieldInterest(this.transformNode._scaleOrientation),this._center.addFieldInterest(this.transformNode._center),this._bboxDisplay.addFieldInterest(this.transformNode._bboxDisplay),this._bboxSize.addFieldInterest(this.transformNode._bboxSize),this._bboxCenter.addFieldInterest(this.transformNode._bboxCenter),this.transformNode._translation=this._translation,this.transformNode._rotation=this._rotation,this.transformNode._scale=this._scale,this.transformNode._scaleOrientation=this._scaleOrientation,this.transformNode._center=this._center,this.transformNode._bboxDisplay=this._bboxDisplay,this.transformNode._bboxSize=this._bboxSize,this.transformNode._bboxCenter=this._bboxCenter,this.transformNode._children=[this.skeletonNode,this.viewpointsNode,this.skinNode],this.transformNode._isCameraObject.addFieldInterest(this._isCameraObject),this.transformNode._isPickableObject.addFieldInterest(this._isPickableObject),this.skeletonNode.setup(),this.viewpointsNode.setup(),this.skinNode.setup(),this.transformNode.setup(),this.setCameraObject(this.transformNode.isCameraObject()),this.setPickableObject(this.transformNode.isPickableObject());const t=this.getBrowser().getContext();if(1!==t.getVersion()){this.jointsTexture=t.createTexture(),this.displacementsTexture=t.createTexture(),this.displacementWeightsTexture=t.createTexture(),this.jointMatricesTexture=t.createTexture();for(const e of[this.jointsTexture,this.displacementsTexture,this.displacementWeightsTexture,this.jointMatricesTexture])t.bindTexture(t.TEXTURE_2D,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR);this._motionsEnabled.addInterest("set_motions__",this),this._motions.addInterest("set_motions__",this),this._jointBindingPositions.addInterest("set_joints__",this),this._jointBindingRotations.addInterest("set_joints__",this),this._jointBindingScales.addInterest("set_joints__",this),this._joints.addInterest("set_joints__",this),this._jointTextures.addInterest("set_jointTextures__",this),this._displacementsTexture.addInterest("set_displacementsTexture__",this),this._displacementWeightsTexture.addInterest("set_displacementWeightsTexture__",this),this._skinCoord.addInterest("set_skinCoord__",this),this.set_motions__(),this.set_joints__(),this.set_skinCoord__()}},getBBox(t,e){return this.transformNode.getBBox(t,e)},getSubBBox(t,e){return this.transformNode.getSubBBox(t,e)},getMatrix(){return this.transformNode.getMatrix()},getHAnimKey(){return this.humanoidKey},getNumJoints(){return this.numJoints},getNumDisplacements(){return this.numDisplacements},set_humanoidKey__(){this.humanoidKey=`[${this.numJoints}.${this.numDisplacements}]`},set_motions__(){const t=this._motionsEnabled,e=this.motionNodes;for(const t of e)t._joints.removeInterest("set_connectJoints__",this),t._channelsEnabled.removeInterest("set_connectJoints__",this),t._channels.removeInterest("set_connectJoints__",this),t._values.removeInterest("set_connectJoints__",this),t.disconnectJoints(this.jointNodes);e.length=0;for(const[n,i]of this._motions.entries()){if(n<t.length&&!t[n])continue;const s=A()(m().HAnimMotion,i);s&&e.push(s)}for(const t of e)t._joints.addInterest("set_connectJoints__",this,t),t._channelsEnabled.addInterest("set_connectJoints__",this,t),t._channels.addInterest("set_connectJoints__",this,t),t._values.addInterest("set_connectJoints__",this,t),t.connectJoints(this.jointNodes)},set_connectJoints__(t){t.disconnectJoints(this.jointNodes),t.connectJoints(this.jointNodes)},set_joints__(){const t=this.jointNodes,e=this.jointBindingMatrices,n=this._jointBindingPositions,i=this._jointBindingRotations,s=this._jointBindingScales,o=n.length,r=i.length,a=s.length;for(const e of this.motionNodes)e.disconnectJoints(t);for(const e of t)e.removeInterest("unlock",this.update),e._skinCoordIndex.removeInterest("addEvent",this._jointTextures),e._skinCoordWeight.removeInterest("addEvent",this._jointTextures),e._displacements.removeInterest("addEvent",this._displacementsTexture),e._displacementWeights.removeInterest("addEvent",this._displacementWeightsTexture);t.length=0,e.length=0;for(const[d,h]of this._joints.entries()){const u=A()(m().HAnimJoint,h);if(!u)continue;const l=o?n[Math.min(d,o-1)].getValue():null,c=r?i[Math.min(d,r-1)].getValue():null,p=a?s[Math.min(d,a-1)].getValue():null;t.push(u),e.push((new(R())).set(l,c,p))}for(const e of t)e.addInterest("unlock",this.update),e._skinCoordIndex.addInterest("addEvent",this._jointTextures),e._skinCoordWeight.addInterest("addEvent",this._jointTextures),e._displacements.addInterest("addEvent",this._displacementsTexture),e._displacementWeights.addInterest("addEvent",this._displacementWeightsTexture);for(const e of this.motionNodes)e.connectJoints(t);const d=Math.ceil(Math.sqrt(8*t.length));this.jointMatricesArray=new Float32Array(d*d*4),this._jointTextures.addEvent(),this._displacementsTexture.addEvent(),this._displacementWeightsTexture.addEvent()},set_jointTextures__(){const t=this.skinCoordNode?._point.length||1,e=Array.from({length:t},(()=>[])),n=Array.from({length:t},(()=>[]));for(const[t,i]of this.jointNodes.entries()){const s=i._skinCoordWeight.getValue();for(const[o,r]of i._skinCoordIndex.entries()){const i=s[o];0!==i&&(e[r]?.push(t),n[r]?.push(i))}}const i=k().roundToMultiple(e.reduce(((t,e)=>Math.max(t,e.length)),0),4),s=2*i,o=Math.ceil(Math.sqrt(t*s))||1,r=new Float32Array(o*o*4);for(let o=0;o<t;++o)r.set(e[o],o*s),r.set(n[o],o*s+i);this.numJoints=i;const a=this.getBrowser().getContext();a.bindTexture(a.TEXTURE_2D,this.jointsTexture),a.texImage2D(a.TEXTURE_2D,0,a.RGBA32F,o,o,0,a.RGBA,a.FLOAT,r),this.update.unlock(),this.set_humanoidKey__()},set_displacementsTexture__(){const t=this.skinCoordNode?._point.length||1,e=Array.from({length:t},(()=>[]));let n=0;this.displacementWeights.length=0;for(const[t,i]of this.jointNodes.entries())for(const{_weight:s,_coordIndex:o,_displacements:r}of i.getDisplacers())if(o.length){this.displacementWeights.push(s,0,0,0);for(const[i,s]of o.entries())e[s]?.push(...r[i],t,n,0,0,0);++n}const i=e.reduce(((t,e)=>Math.max(t,e.length)),0)/8,s=8*i,o=Math.ceil(Math.sqrt(t*i*2))||1,r=new Float32Array(o*o*4);for(let n=0;n<t;++n)r.set(e[n],n*s);this.numDisplacements=i;const a=this.getBrowser().getContext();a.bindTexture(a.TEXTURE_2D,this.displacementsTexture),a.texImage2D(a.TEXTURE_2D,0,a.RGBA32F,o,o,0,a.RGBA,a.FLOAT,r),this.displacementWeightsSize=Math.ceil(Math.sqrt(n)),this.displacementWeightsArray=new Float32Array(this.displacementWeightsSize*this.displacementWeightsSize*4),this.update.unlock(),this.set_humanoidKey__()},set_displacementWeightsTexture__(){const t=this.getBrowser().getContext(),e=this.displacementWeightsSize,n=this.displacementWeightsArray;n.set(this.displacementWeights),t.bindTexture(t.TEXTURE_2D,this.displacementWeightsTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA32F,e,e,0,t.RGBA,t.FLOAT,n)},set_skinCoord__(){this.skinCoordNode&&(this.skinCoordNode.removeInterest("addEvent",this._jointTextures),this.skinCoordNode.removeInterest("addEvent",this._displacementsTexture),this.skinCoordNode.removeInterest("addEvent",this._displacementWeightsTexture)),this.skinCoordNode=A()(m().Coordinate,this._skinCoord)??A()(m().CoordinateDouble,this._skinCoord),this.skinCoordNode?(delete this.skinning,this.skinCoordNode.addInterest("addEvent",this._jointTextures),this.skinCoordNode.addInterest("addEvent",this._displacementsTexture),this.skinCoordNode.addInterest("addEvent",this._displacementWeightsTexture)):this.skinning=Function.prototype,this._jointTextures.addEvent(),this._displacementsTexture.addEvent(),this._displacementWeightsTexture.addEvent()},traverse(t,e){const n=e.getInvHumanoidMatrix();n.push(this.transformNode.getMatrix()),n.multRight(e.getModelViewMatrix().get()),n.inverse(),this.transformNode.traverse(t,e),this.skinning(t,e),n.pop()},skinning(t,e){if(t!==M().DISPLAY||this.update.lock())return;const n=e.getInvHumanoidMatrix().get(),i=this.jointNodes,s=i.length,o=this.jointBindingMatrices,r=this.jointMatricesArray,a=Math.ceil(Math.sqrt(8*s));for(let t=0;t<s;++t){const e=i[t],s=o[t],a=e.getModelViewMatrix().multRight(n).multLeft(s),d=a.submatrix.transpose().inverse();r.set(a,32*t+0),r.set(d,32*t+16)}const d=this.getBrowser().getContext();d.bindTexture(d.TEXTURE_2D,this.jointMatricesTexture),d.texImage2D(d.TEXTURE_2D,0,d.RGBA32F,a,a,0,d.RGBA,d.FLOAT,r)},setShaderUniforms(t,e){const n=this.getBrowser(),i=n.getTexture2DUnit(),s=n.getTexture2DUnit(),o=n.getTexture2DUnit(),r=n.getTexture2DUnit();t.activeTexture(t.TEXTURE0+i),t.bindTexture(t.TEXTURE_2D,this.jointsTexture),t.uniform1i(e.x3d_JointsTexture,i),t.activeTexture(t.TEXTURE0+s),t.bindTexture(t.TEXTURE_2D,this.displacementsTexture),t.uniform1i(e.x3d_DisplacementsTexture,s),t.activeTexture(t.TEXTURE0+o),t.bindTexture(t.TEXTURE_2D,this.displacementWeightsTexture),t.uniform1i(e.x3d_DisplacementWeightsTexture,o),t.activeTexture(t.TEXTURE0+r),t.bindTexture(t.TEXTURE_2D,this.jointMatricesTexture),t.uniform1i(e.x3d_JointMatricesTexture,r)},dispose(){b().prototype.dispose.call(this),I().prototype.dispose.call(this)}}),Object.defineProperties(W,{...l().getStaticProperties("HAnimHumanoid","HAnim",1,"children","3.0"),fieldDefinitions:{value:new(h())([new(a())(m().inputOutput,"metadata",new(o().SFNode)),new(a())(m().inputOutput,"version",new(o().SFString)("2.0")),new(a())(m().inputOutput,"description",new(o().SFString)),new(a())(m().inputOutput,"name",new(o().SFString)),new(a())(m().inputOutput,"info",new(o().MFString)),new(a())(m().inputOutput,"skeletalConfiguration",new(o().SFString)("BASIC")),new(a())(m().inputOutput,"loa",new(o().SFInt32)(-1)),new(a())(m().inputOutput,"translation",new(o().SFVec3f)),new(a())(m().inputOutput,"rotation",new(o().SFRotation)),new(a())(m().inputOutput,"scale",new(o().SFVec3f)(1,1,1)),new(a())(m().inputOutput,"scaleOrientation",new(o().SFRotation)),new(a())(m().inputOutput,"center",new(o().SFVec3f)),new(a())(m().inputOutput,"visible",new(o().SFBool)(!0)),new(a())(m().inputOutput,"bboxDisplay",new(o().SFBool)),new(a())(m().initializeOnly,"bboxSize",new(o().SFVec3f)(-1,-1,-1)),new(a())(m().initializeOnly,"bboxCenter",new(o().SFVec3f)),new(a())(m().inputOutput,"skeleton",new(o().MFNode)),new(a())(m().inputOutput,"jointBindingPositions",new(o().MFVec3f)),new(a())(m().inputOutput,"jointBindingRotations",new(o().MFRotation)),new(a())(m().inputOutput,"jointBindingScales",new(o().MFVec3f)),new(a())(m().inputOutput,"joints",new(o().MFNode)),new(a())(m().inputOutput,"segments",new(o().MFNode)),new(a())(m().inputOutput,"sites",new(o().MFNode)),new(a())(m().inputOutput,"viewpoints",new(o().MFNode)),new(a())(m().inputOutput,"motionsEnabled",new(o().MFBool)),new(a())(m().inputOutput,"motions",new(o().MFNode)),new(a())(m().inputOutput,"skinBindingNormals",new(o().SFNode)),new(a())(m().inputOutput,"skinBindingCoords",new(o().SFNode)),new(a())(m().inputOutput,"skinNormal",new(o().SFNode)),new(a())(m().inputOutput,"skinCoord",new(o().SFNode)),new(a())(m().inputOutput,"skin",new(o().MFNode))]),enumerable:!0}});class B extends(v()){#t;constructor(t,e){super(t),this.#t=e}traverse(t,e){e.getHAnimNode().push(this.#t),super.traverse(t,e),e.getHAnimNode().pop()}}class X{#e=!0;unlock(){this.#e=!1}lock(){const t=this.#e;return this.#e=!0,t}}const V=W,U=w().add("HAnimHumanoid",V),P=t.X3DTransformNode;var H=e.n(P);function J(t){H().call(this,t),this.addType(m().HAnimJoint),this.addChildObjects(m().outputOnly,"displacements",new(o().SFTime),m().outputOnly,"displacementWeights",new(o().SFTime)),this.setAllowedTypes(m().HAnimJoint,m().HAnimSegment,m().HAnimSite),this.displacerNodes=[],this.modelViewMatrix=new(R())}Object.assign(Object.setPrototypeOf(J.prototype,H().prototype),{initialize(){H().prototype.initialize.call(this),this._displacers.addInterest("set_displacers__",this),this.set_displacers__()},getModelViewMatrix(){return this.modelViewMatrix},getDisplacers(){return this.displacerNodes},set_displacers__(){const t=this.displacerNodes;for(const e of t)e._coordIndex.removeInterest("addEvent",this._displacements),e._displacements.removeInterest("addEvent",this._displacements),e._coordIndex.removeInterest("addEvent",this._displacementWeights),e._weight.removeInterest("addEvent",this._displacementWeights);t.length=0;for(const e of this._displacers){const n=A()(m().HAnimDisplacer,e);n&&t.push(n)}for(const e of t)e._coordIndex.addInterest("addEvent",this._displacements),e._displacements.addInterest("addEvent",this._displacements),e._coordIndex.addInterest("addEvent",this._displacementWeights),e._weight.addInterest("addEvent",this._displacementWeights);this._displacements.addEvent(),this._displacementWeights.addEvent()},traverse(t,e){const n=e.getModelViewMatrix();n.push(),n.multLeft(this.getMatrix()),t===M().DISPLAY&&this.modelViewMatrix.assign(n.get()),H().prototype.groupTraverse.call(this,t,e),n.pop()},groupTraverse(t,e){t===M().DISPLAY&&this.modelViewMatrix.assign(e.getModelViewMatrix().get()),H().prototype.groupTraverse.call(this,t,e)}}),Object.defineProperties(J,{...l().getStaticProperties("HAnimJoint","HAnim",1,"children","3.0"),fieldDefinitions:{value:new(h())([new(a())(m().inputOutput,"metadata",new(o().SFNode)),new(a())(m().inputOutput,"description",new(o().SFString)),new(a())(m().inputOutput,"name",new(o().SFString)),new(a())(m().inputOutput,"translation",new(o().SFVec3f)),new(a())(m().inputOutput,"rotation",new(o().SFRotation)),new(a())(m().inputOutput,"scale",new(o().SFVec3f)(1,1,1)),new(a())(m().inputOutput,"scaleOrientation",new(o().SFRotation)),new(a())(m().inputOutput,"center",new(o().SFVec3f)),new(a())(m().inputOutput,"llimit",new(o().MFFloat)(0,0,0)),new(a())(m().inputOutput,"ulimit",new(o().MFFloat)(0,0,0)),new(a())(m().inputOutput,"limitOrientation",new(o().SFRotation)),new(a())(m().inputOutput,"stiffness",new(o().MFFloat)(0,0,0)),new(a())(m().inputOutput,"skinCoordIndex",new(o().MFInt32)),new(a())(m().inputOutput,"skinCoordWeight",new(o().MFFloat)),new(a())(m().inputOutput,"displacers",new(o().MFNode)),new(a())(m().inputOutput,"visible",new(o().SFBool)(!0)),new(a())(m().inputOutput,"bboxDisplay",new(o().SFBool)),new(a())(m().initializeOnly,"bboxSize",new(o().SFVec3f)(-1,-1,-1)),new(a())(m().initializeOnly,"bboxCenter",new(o().SFVec3f)),new(a())(m().inputOnly,"addChildren",new(o().MFNode)),new(a())(m().inputOnly,"removeChildren",new(o().MFNode)),new(a())(m().inputOutput,"children",new(o().MFNode))]),enumerable:!0}});const z=J,L=w().add("HAnimJoint",z),G=t.TimeSensor;var K=e.n(G);const Y=t.PositionInterpolator;var q=e.n(Y);const Z=t.OrientationInterpolator;var $=e.n(Z);const Q=t.Vector3;var tt=e.n(Q);const et=t.Rotation4;var nt=e.n(et);function it(t){I().call(this,t),this.addType(m().HAnimMotion),this.timeSensor=new(K())(this.getExecutionContext()),this.interpolators=[]}Object.assign(Object.setPrototypeOf(it.prototype,I().prototype),{initialize(){I().prototype.initialize.call(this),this._loop.addFieldInterest(this.timeSensor._loop),this.timeSensor._cycleTime.addFieldInterest(this._cycleTime),this.timeSensor._elapsedTime.addFieldInterest(this._elapsedTime),this.timeSensor._enabled=!1,this.timeSensor._loop=this._loop,this.timeSensor._stopTime=1,this.timeSensor.setup(),this._enabled.addInterest("set_enabled__",this),this._joints.addInterest("set_joints__",this),this._channels.addInterest("set_interpolators__",this),this._values.addInterest("set_interpolators__",this),this._next.addInterest("set_next_or_previous__",this,1),this._previous.addInterest("set_next_or_previous__",this,-1),this._frameIndex.addInterest("set_frameIndex__",this),this._frameDuration.addInterest("set_frameDuration__",this),this._frameIncrement.addInterest("set_frameIncrement__",this),this._startFrame.addInterest("set_start_or_endFrame__",this),this._endFrame.addInterest("set_start_or_endFrame__",this),this.set_enabled__(),this.set_joints__(),this.set_frameIncrement__(),this.set_interpolators__()},connectJoints(t){const e=this._channelsEnabled,n=this.joints,i=this.getJointsIndex(t);for(const[t,{positionInterpolator:s,orientationInterpolator:o,scaleInterpolator:r}]of this.interpolators.entries()){if(t<e.length&&!e[t])continue;const a=i.get(n[t]);a&&(s?._value_changed.addFieldInterest(a._translation),o?._value_changed.addFieldInterest(a._rotation),r?._value_changed.addFieldInterest(a._scale))}},disconnectJoints(t){const e=this.joints,n=this.getJointsIndex(t);for(const[t,{positionInterpolator:i,orientationInterpolator:s,scaleInterpolator:o}]of this.interpolators.entries()){const r=n.get(e[t]);r&&(i?._value_changed.removeFieldInterest(r._translation),s?._value_changed.removeFieldInterest(r._rotation),o?._value_changed.removeFieldInterest(r._scale))}},getJointsIndex(t){const e=new Map(t.map((t=>[t._name.getValue().trim(),t])));return e.delete("IGNORED"),e.set("HumanoidRoot",e.get("humanoid_root")),e},set_enabled__(){this._enabled.getValue()?this.timeSensor._startTime=Date.now()/1e3:this.timeSensor._stopTime=Date.now()/1e3},set_joints__(){this.joints=this._joints.getValue().replace(/^[\s,]+|[\s,]+$/gs,"").split(/[\s,]+/s);for(const{positionInterpolator:t,orientationInterpolator:e,scaleInterpolator:n}of this.interpolators)t?._value_changed.getFieldInterests().forEach((e=>t._value_changed.removeFieldInterest(e))),e?._value_changed.getFieldInterests().forEach((t=>e._value_changed.removeFieldInterest(t))),n?._value_changed.getFieldInterests().forEach((t=>n._value_changed.removeFieldInterest(t)))},set_interpolators__(){const t=this.timeSensor;t._fraction_changed.getFieldInterests().forEach((e=>t._fraction_changed.removeFieldInterest(e)));const e=this._channels.getValue().replace(/^[\s,\d]+|[\s,\d]+$/gs,"").split(/[\s,]+\d+[\s,]+/s).map((t=>t.split(/[\s,]+/s))),n=this._values,i=e.reduce(((t,e)=>t+e.length),0),s=Math.floor(i?n.length/i:0),o=new Map,r=Array.from({length:e.length},(()=>({})));this.interpolators=r;for(let i=0,a=0;i<s;++i)for(const[d,h]of e.entries()){o.clear();for(const t of h)o.set(t,n[a++]);if(o.has("Xposition")||o.has("Yposition")||o.has("Zposition")){const e=r[d].positionInterpolator??this.createPositionInterpolator(r,d),n=i/(s-1),a=new(tt())(o.get("Xposition")??0,o.get("Yposition")??0,o.get("Zposition")??0);e._key.push(n),e._keyValue.push(a),t._fraction_changed.addFieldInterest(e._set_fraction)}if(o.has("Xrotation")||o.has("Yrotation")||o.has("Zrotation")){const e=r[d].orientationInterpolator??this.createOrientationInterpolator(r,d),n=i/(s-1),a=nt().fromEuler(k().radians(o.get("Xrotation")??0),k().radians(o.get("Yrotation")??0),k().radians(o.get("Zrotation")??0));e._key.push(n),e._keyValue.push(a),t._fraction_changed.addFieldInterest(e._set_fraction)}if(o.has("Xscale")||o.has("Yscale")||o.has("Zscale")){const e=r[d].scaleInterpolator??this.createScaleInterpolator(r,d),n=i/(s-1),a=new(tt())(o.get("Xscale")??1,o.get("Yscale")??1,o.get("Zscale")??1);e._key.push(n),e._keyValue.push(a),t._fraction_changed.addFieldInterest(e._set_fraction)}}for(const{positionInterpolator:t,orientationInterpolator:e,scaleInterpolator:n}of r)t?.setup(),e?.setup(),n?.setup();this._frameIndex=0,this._startFrame=0,this._endFrame=s-1,this._frameCount=s,this.set_frameDuration__()},set_next_or_previous__(t,e){if(!e.getValue())return;const n=this.getFraction(),i=this._frameCount.getValue(),s=this._frameIncrement.getValue(),o=(i>1?Math.floor(n*(i-1)):0)+s*t;if(o>this.endFrame){if(!this._loop.getValue())return;this._frameIndex=this.startFrame}else if(o<this.startFrame){if(!this._loop.getValue())return;this._frameIndex=this.endFrame}else this._frameIndex=o},set_frameIndex__(){const t=this._frameCount.getValue(),e=k().clamp(this._frameIndex.getValue(),0,t),n=t>1?e/(t-1):0;if(this.timeSensor._range[0]=n,!this.timeSensor._isActive.getValue())for(const t of this.timeSensor._fraction_changed.getFieldInterests())t.setValue(n)},set_frameDuration__(){const t=this._frameCount.getValue(),e=Math.max(this._frameDuration.getValue(),0);this.timeSensor._cycleInterval=t>1?(t-1)*e:0},set_frameIncrement__(){this.timeSensor._enabled=this._frameIncrement.getValue()},set_start_or_endFrame__(){const t=this._frameCount.getValue(),e=k().clamp(this._startFrame.getValue(),0,t),n=k().clamp(this._endFrame.getValue(),0,t);this.startFrame=Math.min(e,n),this.endFrame=Math.max(e,n),this.timeSensor._range[1]=t>1?this.startFrame/(t-1):0,this.timeSensor._range[2]=t>1?this.endFrame/(t-1):0},createPositionInterpolator(t,e){return t[e].positionInterpolator=new(q())(this.getExecutionContext())},createOrientationInterpolator(t,e){return t[e].orientationInterpolator=new($())(this.getExecutionContext())},createScaleInterpolator(t,e){return t[e].scaleInterpolator=new(q())(this.getExecutionContext())},getFraction(){for(const t of this.timeSensor._fraction_changed.getFieldInterests())return t.getValue();return 0}}),Object.defineProperties(it,{...l().getStaticProperties("HAnimMotion","HAnim",2,"motions","4.0"),fieldDefinitions:{value:new(h())([new(a())(m().inputOutput,"metadata",new(o().SFNode)),new(a())(m().inputOutput,"description",new(o().SFString)),new(a())(m().inputOutput,"name",new(o().SFString)),new(a())(m().inputOutput,"enabled",new(o().SFBool)(!0)),new(a())(m().inputOutput,"loa",new(o().SFInt32)(-1)),new(a())(m().inputOutput,"joints",new(o().SFString)),new(a())(m().inputOutput,"channelsEnabled",new(o().MFBool)),new(a())(m().inputOutput,"channels",new(o().SFString)),new(a())(m().inputOutput,"values",new(o().MFFloat)),new(a())(m().inputOutput,"loop",new(o().SFBool)),new(a())(m().inputOnly,"next",new(o().SFBool)),new(a())(m().inputOnly,"previous",new(o().SFBool)),new(a())(m().inputOutput,"frameIndex",new(o().SFInt32)),new(a())(m().inputOutput,"frameDuration",new(o().SFTime)(.1)),new(a())(m().inputOutput,"frameIncrement",new(o().SFInt32)(1)),new(a())(m().inputOutput,"startFrame",new(o().SFInt32)),new(a())(m().inputOutput,"endFrame",new(o().SFInt32)),new(a())(m().outputOnly,"cycleTime",new(o().SFTime)),new(a())(m().outputOnly,"elapsedTime",new(o().SFTime)),new(a())(m().outputOnly,"frameCount",new(o().SFInt32))]),enumerable:!0}});const st=it,ot=w().add("HAnimMotion",st),rt=t.X3DGroupingNode;var at=e.n(rt);function dt(t){at().call(this,t),this.addType(m().HAnimSegment),this.addChildObjects(m().outputOnly,"displacementsTexture",new(o().SFTime),m().outputOnly,"displacementWeightsTexture",new(o().SFTime)),this._mass.setUnit("mass");const e=Math.ceil(Math.sqrt(8));this.numJoints=0,this.numDisplacements=0,this.displacerNodes=[],this.displacementWeights=[],this.jointMatricesArray=new Float32Array(e*e*4)}Object.assign(Object.setPrototypeOf(dt.prototype,at().prototype),{initialize(){at().prototype.initialize.call(this);const t=this.getBrowser().getContext();if(1!==t.getVersion()){this.displacementsTexture=t.createTexture(),this.displacementWeightsTexture=t.createTexture(),this.jointMatricesTexture=t.createTexture();for(const e of[this.displacementsTexture,this.displacementWeightsTexture,this.jointMatricesTexture])t.bindTexture(t.TEXTURE_2D,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR);this._displacers.addInterest("set_displacers__",this),this._coord.addInterest("set_coord__",this),this._displacementsTexture.addInterest("set_displacementsTexture__",this),this._displacementWeightsTexture.addInterest("set_displacementWeightsTexture__",this),this.set_displacers__(),this.set_coord__()}},getHAnimKey(){return this.humanoidKey},getNumJoints(){return this.numJoints},getNumDisplacements(){return this.numDisplacements},set_humanoidKey__(){this.humanoidKey=`[${this.numJoints}.${this.numDisplacements}]`},set_displacers__(){const t=this.displacerNodes;for(const e of t)e._coordIndex.removeInterest("addEvent",this._displacementsTexture),e._displacements.removeInterest("addEvent",this._displacementsTexture),e._coordIndex.removeInterest("addEvent",this._displacementWeightsTexture),e._weight.removeInterest("addEvent",this._displacementWeightsTexture);t.length=0;for(const e of this._displacers){const n=A()(m().HAnimDisplacer,e);n&&t.push(n)}for(const e of t)e._coordIndex.addInterest("addEvent",this._displacementsTexture),e._displacements.addInterest("addEvent",this._displacementsTexture),e._coordIndex.addInterest("addEvent",this._displacementWeightsTexture),e._weight.addInterest("addEvent",this._displacementWeightsTexture);this._displacementsTexture.addEvent(),this._displacementWeightsTexture.addEvent()},set_displacementsTexture__(){const t=this.coordNode?._point.length||1,e=Array.from({length:t},(()=>[]));let n=0;this.displacementWeights.length=0;for(const{_weight:t,_coordIndex:i,_displacements:s}of this.displacerNodes)if(i.length){this.displacementWeights.push(t,0,0,0);for(const[t,o]of i.entries())e[o]?.push(...s[t],0,n,0,0,0);++n}const i=e.reduce(((t,e)=>Math.max(t,e.length)),0)/8,s=8*i,o=Math.ceil(Math.sqrt(t*i*2))||1,r=new Float32Array(o*o*4);for(let n=0;n<t;++n)r.set(e[n],n*s);this.numDisplacements=i;const a=this.getBrowser().getContext();a.bindTexture(a.TEXTURE_2D,this.displacementsTexture),a.texImage2D(a.TEXTURE_2D,0,a.RGBA32F,o,o,0,a.RGBA,a.FLOAT,r),this.displacementWeightsSize=Math.ceil(Math.sqrt(n)),this.displacementWeightsArray=new Float32Array(this.displacementWeightsSize*this.displacementWeightsSize*4),this.set_humanoidKey__()},set_displacementWeightsTexture__(){const t=this.getBrowser().getContext(),e=this.displacementWeightsSize,n=this.displacementWeightsArray;n.set(this.displacementWeights),t.bindTexture(t.TEXTURE_2D,this.displacementWeightsTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA32F,e,e,0,t.RGBA,t.FLOAT,n)},set_coord__(){this.coordNode&&(this.coordNode.removeInterest("addEvent",this._displacementsTexture),this.coordNode.removeInterest("addEvent",this._displacementWeightsTexture)),this.coordNode=A()(m().Coordinate,this._coord)??A()(m().CoordinateDouble,this._coord),this.coordNode?(delete this.skinning,this.coordNode.addInterest("addEvent",this._displacementsTexture),this.coordNode.addInterest("addEvent",this._displacementWeightsTexture)):this.skinning=Function.prototype,this._displacementsTexture.addEvent(),this._displacementWeightsTexture.addEvent()},traverse(t,e){this.coordNode&&e.getHAnimNode().push(this),at().prototype.traverse.call(this,t,e),this.skinning(t,e),this.coordNode&&e.getHAnimNode().pop()},skinning:(()=>{const t=new(R());return function(e,n){if(e!==M().DISPLAY)return;const i=n.getInvHumanoidMatrix().get(),s=this.jointMatricesArray,o=Math.ceil(Math.sqrt(8)),r=t.assign(n.getModelViewMatrix().get()).multRight(i);s.set(r,0);const a=this.getBrowser().getContext();a.bindTexture(a.TEXTURE_2D,this.jointMatricesTexture),a.texImage2D(a.TEXTURE_2D,0,a.RGBA32F,o,o,0,a.RGBA,a.FLOAT,s)}})(),setShaderUniforms(t,e){const n=this.getBrowser(),i=n.getTexture2DUnit(),s=n.getTexture2DUnit(),o=n.getTexture2DUnit();t.activeTexture(t.TEXTURE0+i),t.bindTexture(t.TEXTURE_2D,this.displacementsTexture),t.uniform1i(e.x3d_DisplacementsTexture,i),t.activeTexture(t.TEXTURE0+s),t.bindTexture(t.TEXTURE_2D,this.displacementWeightsTexture),t.uniform1i(e.x3d_DisplacementWeightsTexture,s),t.activeTexture(t.TEXTURE0+o),t.bindTexture(t.TEXTURE_2D,this.jointMatricesTexture),t.uniform1i(e.x3d_JointMatricesTexture,o)}}),Object.defineProperties(dt,{...l().getStaticProperties("HAnimSegment","HAnim",1,"children","3.0"),fieldDefinitions:{value:new(h())([new(a())(m().inputOutput,"metadata",new(o().SFNode)),new(a())(m().inputOutput,"description",new(o().SFString)),new(a())(m().inputOutput,"name",new(o().SFString)),new(a())(m().inputOutput,"mass",new(o().SFFloat)),new(a())(m().inputOutput,"centerOfMass",new(o().SFVec3f)),new(a())(m().inputOutput,"momentsOfInertia",new(o().MFFloat)(0,0,0,0,0,0,0,0,0)),new(a())(m().inputOutput,"displacers",new(o().MFNode)),new(a())(m().inputOutput,"coord",new(o().SFNode)),new(a())(m().inputOutput,"visible",new(o().SFBool)(!0)),new(a())(m().inputOutput,"bboxDisplay",new(o().SFBool)),new(a())(m().initializeOnly,"bboxSize",new(o().SFVec3f)(-1,-1,-1)),new(a())(m().initializeOnly,"bboxCenter",new(o().SFVec3f)),new(a())(m().inputOnly,"addChildren",new(o().MFNode)),new(a())(m().inputOnly,"removeChildren",new(o().MFNode)),new(a())(m().inputOutput,"children",new(o().MFNode))]),enumerable:!0}});const ht=dt,ut=w().add("HAnimSegment",ht);function lt(t){H().call(this,t),this.addType(m().HAnimSite)}Object.setPrototypeOf(lt.prototype,H().prototype),Object.defineProperties(lt,{...l().getStaticProperties("HAnimSite","HAnim",1,"children","3.0"),fieldDefinitions:{value:new(h())([new(a())(m().inputOutput,"metadata",new(o().SFNode)),new(a())(m().inputOutput,"description",new(o().SFString)),new(a())(m().inputOutput,"name",new(o().SFString)),new(a())(m().inputOutput,"translation",new(o().SFVec3f)),new(a())(m().inputOutput,"rotation",new(o().SFRotation)),new(a())(m().inputOutput,"scale",new(o().SFVec3f)(1,1,1)),new(a())(m().inputOutput,"scaleOrientation",new(o().SFRotation)),new(a())(m().inputOutput,"center",new(o().SFVec3f)),new(a())(m().inputOutput,"visible",new(o().SFBool)(!0)),new(a())(m().inputOutput,"bboxDisplay",new(o().SFBool)),new(a())(m().initializeOnly,"bboxSize",new(o().SFVec3f)(-1,-1,-1)),new(a())(m().initializeOnly,"bboxCenter",new(o().SFVec3f)),new(a())(m().inputOnly,"addChildren",new(o().MFNode)),new(a())(m().inputOnly,"removeChildren",new(o().MFNode)),new(a())(m().inputOutput,"children",new(o().MFNode))]),enumerable:!0}});const ct=lt,pt=w().add("HAnimSite",ct);i().add({name:"HAnim",concreteNodes:[f,U,L,ot,ut,pt],abstractNodes:[]});w().add("HAnimComponent",undefined)})();